<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronFlow - Workout Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { 'racing': ['Bebas Neue', 'sans-serif'], 'sans': ['Inter', 'sans-serif'] },
            colors: { 'racing-red': '#DC2626', 'racing-blue': '#2563EB', 'racing-cyan': '#06B6D4' }
          }
        }
      }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior: none; -webkit-font-smoothing: antialiased; margin: 0; padding: 0; }
        .racing-stripes { background: linear-gradient(90deg, transparent 45%, #2563EB 45%, #2563EB 48%, #06B6D4 48%, #06B6D4 52%, #2563EB 52%, #2563EB 55%, transparent 55%); }
        .red-metallic { background: linear-gradient(135deg, #DC2626 0%, #EF4444 25%, #DC2626 50%, #B91C1C 75%, #991B1B 100%); }
        .metallic-shine { background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.3) 100%); }
        @keyframes pulse-gauge { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.05); opacity: 0.8; } }
        .gauge-indicator { animation: pulse-gauge 2s ease-in-out infinite; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-slate-950 text-white">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // SVG Icons
        const Icon = ({ children, className = "", ...props }) => (
            <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24" {...props}>{children}</svg>
        );

        const Dumbbell = ({ className }) => <Icon className={className}><path d="M14.4 14.4 9.6 9.6"/><path d="M18.657 21.485a2 2 0 1 1-2.829-2.828l-1.767 1.768a2 2 0 1 1-2.829-2.829l6.364-6.364a2 2 0 1 1 2.829 2.829l-1.768 1.767a2 2 0 1 1 2.828 2.829z"/><path d="m21.5 21.5-1.4-1.4"/><path d="M3.9 3.9 2.5 2.5"/><path d="M6.404 12.768a2 2 0 1 1-2.829-2.829l1.768-1.767a2 2 0 1 1-2.828-2.829l2.828-2.828a2 2 0 1 1 2.829 2.828l1.767-1.768a2 2 0 1 1 2.829 2.829z"/></Icon>;
        const Plus = ({ className }) => <Icon className={className}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const Minus = ({ className }) => <Icon className={className}><path d="M5 12h14"/></Icon>;
        const X = ({ className }) => <Icon className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
        const Settings = ({ className }) => <Icon className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const ChevronDown = ({ className }) => <Icon className={className}><path d="m6 9 6 6 6-6"/></Icon>;
        const ChevronRight = ({ className }) => <Icon className={className}><path d="m9 18 6-6-6-6"/></Icon>;
        const Calendar = ({ className }) => <Icon className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>;
        const BarChart3 = ({ className }) => <Icon className={className}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></Icon>;
        const Shuffle = ({ className }) => <Icon className={className}><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l6.1-8.6c.7-1.1 2-1.7 3.3-1.7H22"/><path d="m18 2 4 4-4 4"/><path d="M2 6h1.9c1.5 0 2.9.9 3.6 2.2"/><path d="M22 18h-5.9c-1.3 0-2.6-.7-3.3-1.8l-.5-.8"/><path d="m18 14 4 4-4 4"/></Icon>;
        const Check = ({ className }) => <Icon className={className}><polyline points="20 6 9 17 4 12"/></Icon>;
        const Save = ({ className }) => <Icon className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const RefreshCw = ({ className }) => <Icon className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>;

        // Exercise substitution database (compact)
        const EXERCISE_SUBS = {"Dumbbell Incline Chest Press":[{"name":"Double Dumbbell Reverse Grip Bench Press","difficulty":"Novice","equipment":"Dumbbell"},{"name":"Double Dumbbell Bench Press","difficulty":"Beginner","equipment":"Dumbbell"},{"name":"Barbell Bench Press","difficulty":"Novice","equipment":"Barbell"},{"name":"Bodyweight Push Up","difficulty":"Novice","equipment":"Bodyweight"}],"Machine Chest Press":[{"name":"Double Cable Chest Fly","difficulty":"Beginner","equipment":"Cable"},{"name":"Double Dumbbell Bench Press","difficulty":"Beginner","equipment":"Dumbbell"},{"name":"Barbell Bench Press","difficulty":"Novice","equipment":"Barbell"}],"Low to High Cable Fly":[{"name":"Double Cable Chest Fly","difficulty":"Beginner","equipment":"Cable"},{"name":"Double Dumbbell Chest Fly","difficulty":"Beginner","equipment":"Dumbbell"}],"Feet Elevated Push Up":[{"name":"Bodyweight Push Up","difficulty":"Novice","equipment":"Bodyweight"},{"name":"Bodyweight Kneeling Push Up","difficulty":"Beginner","equipment":"Bodyweight"}],"T-Bar Row":[{"name":"Barbell Pendlay Row","difficulty":"Novice","equipment":"Barbell"},{"name":"Barbell Bent Over Row","difficulty":"Novice","equipment":"Barbell"},{"name":"Landmine V Grip Row","difficulty":"Novice","equipment":"Landmine"}],"Lat Pulldown":[{"name":"Cable Wide Grip Lat Pulldown","difficulty":"Beginner","equipment":"Cable"},{"name":"Cable V Grip Lat Pulldown","difficulty":"Beginner","equipment":"Cable"}],"Single Arm Pulldown":[{"name":"Single Arm Cable Half Kneeling Lat Pulldown","difficulty":"Novice","equipment":"Cable"},{"name":"Cable Wide Grip Lat Pulldown","difficulty":"Beginner","equipment":"Cable"}],"Prone Incline DB Row":[{"name":"Double Dumbbell Pendlay Row","difficulty":"Novice","equipment":"Dumbbell"},{"name":"Double Dumbbell Bent Over Row","difficulty":"Beginner","equipment":"Dumbbell"}],"Seated Hamstring Curl":[{"name":"Cable Prone Hamstring Curl","difficulty":"Beginner","equipment":"Cable"},{"name":"Double Dumbbell Romanian Deadlift","difficulty":"Beginner","equipment":"Dumbbell"}],"Bulgarian Split Squat":[{"name":"Double Dumbbell Thruster","difficulty":"Novice","equipment":"Dumbbell"},{"name":"Dumbbell Goblet Squat","difficulty":"Beginner","equipment":"Dumbbell"}],"Hack Squat":[{"name":"Barbell Box Back Squat","difficulty":"Novice","equipment":"Barbell"},{"name":"Barbell High Bar Back Squat","difficulty":"Novice","equipment":"Barbell"}],"Alternating Lunge Barbell":[{"name":"Barbell Box Back Squat","difficulty":"Novice","equipment":"Barbell"},{"name":"Barbell High Bar Back Squat","difficulty":"Novice","equipment":"Barbell"}],"Seated Shoulder Press":[{"name":"Double Dumbbell Z Press","difficulty":"Novice","equipment":"Dumbbell"},{"name":"Barbell Overhead Press","difficulty":"Novice","equipment":"Barbell"}],"Dumbbell Side Lateral Raise":[{"name":"Double Dumbbell Lateral Raise","difficulty":"Beginner","equipment":"Dumbbell"},{"name":"Single Arm Cable Lateral Raise","difficulty":"Beginner","equipment":"Cable"}],"Machine Preacher Curl":[{"name":"Cable Straight Bar Bicep Curl","difficulty":"Beginner","equipment":"Cable"},{"name":"Barbell Curl","difficulty":"Beginner","equipment":"Barbell"},{"name":"Dumbbell Curl","difficulty":"Beginner","equipment":"Dumbbell"}],"Cross Body Tricep Extension":[{"name":"Cable Rope Skull Crusher","difficulty":"Novice","equipment":"Cable"},{"name":"Single Arm Cable Tricep Kickback","difficulty":"Beginner","equipment":"Cable"}],"Low Pulley Cable Curl":[{"name":"Cable Straight Bar Bicep Curl","difficulty":"Beginner","equipment":"Cable"},{"name":"Barbell Curl","difficulty":"Beginner","equipment":"Barbell"},{"name":"Dumbbell Curl","difficulty":"Beginner","equipment":"Dumbbell"}]};

        function App() {
            const [activeTab, setActiveTab] = useState('push');
            const [showSettings, setShowSettings] = useState(false);
            const [showSubstitutes, setShowSubstitutes] = useState(false);
            const [showWorkoutSummary, setShowWorkoutSummary] = useState(false);
            const [selectedExercise, setSelectedExercise] = useState(null);
            const [customEdit, setCustomEdit] = useState({ originalName: null, value: '' }); // inline custom exercise entry
            // Google Sheets integration
            // sheetUrl: the user's Google Sheet link
            // scriptUrl: the user's deployed Apps Script Web App URL
            const [sheetUrl, setSheetUrl] = useState(localStorage.getItem('sheetUrl') || '');
            const [scriptUrl, setScriptUrl] = useState(localStorage.getItem('scriptUrl') || '');
            const [expandedExercise, setExpandedExercise] = useState(null);
            const [activeView, setActiveView] = useState('workout'); // workout | history
            const [historyItems, setHistoryItems] = useState([]);
            const [historyStatus, setHistoryStatus] = useState({ loading: false, error: '' });
            const [toast, setToast] = useState(null); // { type: 'success'|'error'|'info', message: string }
            const [customExercises, setCustomExercises] = useState(() => {
                const saved = localStorage.getItem('customExercises');
                return saved ? JSON.parse(saved) : {};
            });

            // Workout type (saved name). Allows preset types + custom.
            const TAB_LABELS = { push: 'Push', pull: 'Pull', legs: 'Legs', shoulders: 'Shoulders' };
            const WORKOUT_TYPE_OPTIONS = ['Push', 'Pull', 'Legs', 'Shoulders'];
            const [workoutType, setWorkoutType] = useState(() => {
                return localStorage.getItem('workoutType') || 'Push';
            });
            const [customWorkoutType, setCustomWorkoutType] = useState(() => {
                return localStorage.getItem('customWorkoutType') || '';
            });
            const isCustomWorkoutType = workoutType === '__custom__';
            const getEffectiveWorkoutType = () => {
                const base = TAB_LABELS[activeTab] || 'Workout';
                const v = isCustomWorkoutType ? (customWorkoutType || '').trim() : (workoutType || '').trim();
                return v || base;
            };

            // Per-exercise target set count (default 4), persisted
            const [exerciseTargetSets, setExerciseTargetSets] = useState(() => {
                const saved = localStorage.getItem('exerciseTargetSets');
                return saved ? JSON.parse(saved) : {};
            });
            
            // Current workout session data
            const [currentWorkout, setCurrentWorkout] = useState(() => {
                const saved = localStorage.getItem('currentWorkout');
                return saved ? JSON.parse(saved) : {};
            });

            const programs = {
                push: {
                    name: 'Push',
                    exercises: [
                        { id: 'push-1', name: 'Dumbbell Incline Chest Press', sets: 2, reps: '8-10, 15', rest: 90 },
                        { id: 'push-2', name: 'Machine Chest Press', sets: 3, reps: '10-12', rest: 90 },
                        { id: 'push-3', name: 'Low to High Cable Fly', sets: 3, reps: '15 + DS', rest: 60 },
                        { id: 'push-4', name: 'Feet Elevated Push Up', sets: 2, reps: 'Failure', rest: 60 }
                    ]
                },
                pull: {
                    name: 'Pull',
                    exercises: [
                        { id: 'pull-1', name: 'T-Bar Row', sets: 3, reps: '10-12', rest: 90 },
                        { id: 'pull-2', name: 'Lat Pulldown', sets: 3, reps: '8-10, 10-12', rest: 60 },
                        { id: 'pull-3', name: 'Single Arm Pulldown', sets: 3, reps: '12-15/side', rest: 60 },
                        { id: 'pull-4', name: 'Prone Incline DB Row', sets: 4, reps: '10-12 + DS', rest: 60 }
                    ]
                },
                legs: {
                    name: 'Legs',
                    exercises: [
                        { id: 'legs-1', name: 'Seated Hamstring Curl', sets: 4, reps: '15/12/12/8', rest: 90 },
                        { id: 'legs-2', name: 'Bulgarian Split Squat', sets: 3, reps: '8-12/side', rest: 60 },
                        { id: 'legs-3', name: 'Hack Squat', sets: 4, reps: '15/12/6/20', rest: 90 },
                        { id: 'legs-4', name: 'Alternating Lunge Barbell', sets: 3, reps: '10-12/side', rest: 60 }
                    ]
                },
                shoulders: {
                    name: 'Shoulders',
                    exercises: [
                        { id: 'shoulders-1', name: 'Seated Shoulder Press', sets: 3, reps: '10/15/15', rest: 60 },
                        { id: 'shoulders-2', name: 'Dumbbell Side Lateral Raise', sets: 4, reps: '10-12', rest: 60 },
                        { id: 'shoulders-3', name: 'Machine Preacher Curl', sets: 3, reps: '10-15', rest: 60 },
                        { id: 'shoulders-4', name: 'Cross Body Tricep Extension', sets: 3, reps: '10-15', rest: 60 },
                        { id: 'shoulders-5', name: 'Low Pulley Cable Curl', sets: 3, reps: '10-12', rest: 60 }
                    ]
                }
            };

            const showToast = (type, message) => {
                setToast({ type, message });
                window.clearTimeout(window.__toastTimer);
                window.__toastTimer = window.setTimeout(() => setToast(null), 3500);
            };

            const extractSpreadsheetId = (url) => {
                if (!url) return '';
                const m = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                return m ? m[1] : '';
            };

// JSONP helper to call Apps Script Web App from GitHub Pages / mobile Safari without CORS issues
const jsonpRequest = (baseUrl, params) => {
    return new Promise((resolve, reject) => {
        try {
            const cb = `raygym_cb_${Math.random().toString(36).slice(2)}`;
            const url = new URL(baseUrl);
            Object.entries(params || {}).forEach(([k, v]) => url.searchParams.set(k, String(v)));
            url.searchParams.set('callback', cb);

            const script = document.createElement('script');
            window[cb] = (data) => {
                resolve(data);
                try { delete window[cb]; } catch (_) { window[cb] = undefined; }
                script.remove();
            };
            script.onerror = () => {
                reject(new Error('JSONP request failed'));
                try { delete window[cb]; } catch (_) { window[cb] = undefined; }
                script.remove();
            };
            script.src = url.toString();
            document.body.appendChild(script);
        } catch (err) {
            reject(err);
        }
    });
};

const rowsToHistoryItems = (rows) => {
    if (!Array.isArray(rows)) return [];
    const startIdx = (rows[0] && String(rows[0][0]).toLowerCase().includes('timestamp')) ? 1 : 0;
    const items = [];
    for (let i = startIdx; i < rows.length; i++) {
        const r = rows[i] || [];
        const timestamp = r[0];
        const date = r[1];
        const workoutName = r[2];
        const exercisesJson = r[3];
        let exercises = [];
        try { exercises = JSON.parse(exercisesJson || '[]'); } catch (_) { exercises = []; }

        const normalizedExercises = (Array.isArray(exercises) ? exercises : []).map((ex) => {
            const setsObj = ex?.sets || {};
            const setsLogged = setsObj ? Object.keys(setsObj).length : 0;
            return { name: ex?.name || ex?.originalName || 'Exercise', setsLogged };
        });

        const totalSets = normalizedExercises.reduce((sum, ex) => sum + (ex.setsLogged || 0), 0);

        items.push({
            timestamp: timestamp || '',
            date: date || '',
            workoutName: workoutName || 'Workout',
            programName: workoutName || 'Workout',
            totalSets,
            exercises: normalizedExercises
        });
    }
    return items;
};

            const getTargetSets = (exerciseId, fallbackProgramSets) => {
                // Requirement: default to 4 sets, user can adjust +/-
                const saved = exerciseTargetSets?.[exerciseId];
                if (typeof saved === 'number' && !Number.isNaN(saved)) return saved;
                // If no saved value, default to 4 (ignore program default as requested)
                return 4;
            };

            const getDisplayExercise = (originalName) => customExercises[originalName] || originalName;

            const substituteExercise = (originalName, newName) => {
                const updated = { ...customExercises, [originalName]: newName };
                setCustomExercises(updated);
                localStorage.setItem('customExercises', JSON.stringify(updated));
                setShowSubstitutes(false);
            };

            const resetExercise = (originalName) => {
                const updated = { ...customExercises };
                delete updated[originalName];
                setCustomExercises(updated);
                localStorage.setItem('customExercises', JSON.stringify(updated));
            };

            const logSet = (exerciseId, setNumber, weight, reps) => {
                const updated = { ...currentWorkout };
                if (!updated[exerciseId]) {
                    updated[exerciseId] = { sets: {} };
                }
                const w = weight === '' ? '' : Number(weight);
                const r = reps === '' ? '' : Number(reps);
                updated[exerciseId].sets[setNumber] = {
                    weight: w === '' ? '' : (Number.isFinite(w) ? w : ''),
                    reps: r === '' ? '' : (Number.isFinite(r) ? Math.trunc(r) : '')
                };
                setCurrentWorkout(updated);
                localStorage.setItem('currentWorkout', JSON.stringify(updated));
            };

            const adjustTargetSets = (exerciseId, nextCount) => {
                const safe = Math.max(1, Math.min(12, nextCount));
                const updatedTargets = { ...exerciseTargetSets, [exerciseId]: safe };
                setExerciseTargetSets(updatedTargets);
                localStorage.setItem('exerciseTargetSets', JSON.stringify(updatedTargets));

                // If user reduced sets, prune logged sets above the new max
                if (currentWorkout?.[exerciseId]?.sets) {
                    const updatedWorkout = { ...currentWorkout };
                    const sets = { ...updatedWorkout[exerciseId].sets };
                    Object.keys(sets).forEach((k) => {
                        const n = Number(k);
                        if (n > safe) delete sets[k];
                    });
                    updatedWorkout[exerciseId] = { ...updatedWorkout[exerciseId], sets };
                    setCurrentWorkout(updatedWorkout);
                    localStorage.setItem('currentWorkout', JSON.stringify(updatedWorkout));
                }
            };

            const clearWorkout = () => {
                setCurrentWorkout({});
                localStorage.removeItem('currentWorkout');
            };

            // Cross-platform save transport:
            // - iOS Safari often fails for large JSONP URLs (URL length limits).
            // - Use POST via sendBeacon when available (best), otherwise use a hidden form+iframe.
            // We confirm success by reloading history after the POST.
            const postToAppsScript = (url, jsonString) => {
                return new Promise((resolve, reject) => {
                    try {
                        // Prefer sendBeacon (reliable on iOS/Android/Windows, avoids CORS & URL limits)
                        if (navigator && typeof navigator.sendBeacon === 'function') {
                            const blob = new Blob([jsonString], { type: 'text/plain;charset=UTF-8' });
                            const ok = navigator.sendBeacon(url, blob);
                            if (!ok) {
                                reject(new Error('sendBeacon failed'));
                                return;
                            }
                            resolve({ ok: true, via: 'beacon' });
                            return;
                        }

                        // Fallback: hidden form POST to a hidden iframe
                        const iframeName = 'raygym_save_iframe_' + Math.random().toString(36).slice(2);
                        const iframe = document.createElement('iframe');
                        iframe.name = iframeName;
                        iframe.style.display = 'none';

                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = url;
                        form.target = iframeName;
                        form.style.display = 'none';

                        // Send as form field `data` to avoid CORS preflight
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'data';
                        input.value = jsonString;
                        form.appendChild(input);

                        const cleanup = () => {
                            iframe.onload = null;
                            iframe.onerror = null;
                            try { form.remove(); } catch (_) {}
                            try { iframe.remove(); } catch (_) {}
                        };

                        iframe.onload = () => {
                            cleanup();
                            resolve({ ok: true, via: 'form' });
                        };
                        iframe.onerror = () => {
                            cleanup();
                            reject(new Error('iframe post failed'));
                        };

                        document.body.appendChild(iframe);
                        document.body.appendChild(form);
                        form.submit();
                    } catch (err) {
                        reject(err);
                    }
                });
            };

            const saveWorkout = async () => {
                const timestamp = new Date().toISOString();
                const workoutData = {
                    timestamp,
                    program: activeTab,
                    workoutName: getEffectiveWorkoutType(),
                    spreadsheetId: extractSpreadsheetId(sheetUrl),
                    spreadsheetUrl: sheetUrl,
                    exercises: Object.keys(currentWorkout)
                        .map(exerciseId => {
                            const exercise = programs[activeTab].exercises.find(e => e.id === exerciseId);
                            const targetSets = getTargetSets(exerciseId, exercise?.sets);
                            return {
                                exerciseId,
                                name: getDisplayExercise(exercise.name),
                                originalName: exercise.name,
                                targetSets,
                                sets: currentWorkout[exerciseId].sets
                            };
                        })
                        .filter(Boolean)
                };

                // Local backup (offline-first). Sheet is the source of truth for History when configured.
                const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
                history.unshift(workoutData);
                localStorage.setItem('workoutHistory', JSON.stringify(history.slice(0, 100)));

                // Validate settings
                if (!sheetUrl || !scriptUrl) {
                    showToast('error', 'Missing Google Sheets settings. Open Settings to connect your sheet.');
                    return;
                }
                if (!workoutData.spreadsheetId) {
                    showToast('error', 'Invalid Google Sheet URL. Please paste a full Google Sheet link.');
                    return;
                }

                // Save to Google Sheets via Apps Script Web App
                try {

                    // POST instead of JSONP GET to avoid iOS/Android URL-length limits.
                    // Backend (Apps Script) should support doPost and accept either raw JSON
                    // or form field `data` containing the JSON string.
                    const postBody = JSON.stringify({
                        action: 'append_workout',
                        spreadsheetId: workoutData.spreadsheetId,
                        payload: {
                            timestamp: workoutData.timestamp,
                            date: workoutData.date,
                            program: workoutData.program,
                            workoutName: workoutData.workoutName,
                            workoutType: workoutData.workoutName,
                            exercises: workoutData.exercises
                        }
                    });

                    await postToAppsScript(scriptUrl, postBody);

                    // Optimistic success, then confirm by reloading history.
                    showToast('success', 'Saved to Google Sheets.');
                    clearWorkout();
                    setShowWorkoutSummary(false);
                    // Confirm/refresh history (best effort)
                    setTimeout(() => loadHistoryFromSheets(), 400);
                } catch (error) {
                    console.error('Google Sheets save failed:', error);
                    showToast('error', 'Save failed. Check your network and Apps Script deployment settings.');
                }
            };

            const getTotalSetsLogged = () => {
                return Object.values(currentWorkout).reduce((total, ex) => {
                    return total + Object.keys(ex.sets).length;
                }, 0);
            };

            const loadHistoryFromSheets = async () => {
                if (!sheetUrl || !scriptUrl) return;
                const spreadsheetId = extractSpreadsheetId(sheetUrl);
                if (!spreadsheetId) return;

                setHistoryStatus({ loading: true, error: '' });
                try {

const resp = await jsonpRequest(scriptUrl, {
    action: 'history',
    spreadsheetId
});

if (!resp || (resp.ok !== true && resp.success !== true)) {
    const msg = resp?.error || resp?.message || 'History load failed.';
    setHistoryStatus({ loading: false, error: msg });
    return;
}

const items = Array.isArray(resp.items) ? resp.items : rowsToHistoryItems(resp.rows);
setHistoryItems(items);
setHistoryStatus({ loading: false, error: '' });
                } catch (err) {
                    console.error('History load failed:', err);
                    setHistoryStatus({ loading: false, error: 'History load failed. Check your network and Apps Script settings.' });
                }
            };

            useEffect(() => {
                localStorage.setItem('currentWorkout', JSON.stringify(currentWorkout));
            }, [currentWorkout]);

            useEffect(() => {
                // Keep workout type in sync with the selected template unless the user chose custom.
                if (!isCustomWorkoutType) {
                    const next = TAB_LABELS[activeTab] || 'Workout';
                    if (workoutType !== next) setWorkoutType(next);
                }
                // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [activeTab]);

            useEffect(() => {
                localStorage.setItem('workoutType', workoutType);
            }, [workoutType]);

            useEffect(() => {
                localStorage.setItem('customWorkoutType', customWorkoutType);
            }, [customWorkoutType]);

            useEffect(() => {
                // Load history whenever the connected sheet changes
                loadHistoryFromSheets();
            }, [sheetUrl, scriptUrl]);

            return (
                <div className="min-h-screen pb-32">
                    <div className="h-1 racing-stripes"></div>

                    {toast && (
                        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[60] w-[min(640px,calc(100%-2rem))]">
                            <div className={`px-4 py-3 rounded-lg border shadow-2xl backdrop-blur-sm ${toast.type === 'success' ? 'bg-emerald-950/80 border-emerald-600 text-emerald-100' : toast.type === 'error' ? 'bg-red-950/80 border-red-600 text-red-100' : 'bg-slate-900/80 border-slate-600 text-slate-100'}`}>
                                <div className="flex items-start justify-between gap-4">
                                    <p className="text-sm leading-5">{toast.message}</p>
                                    <button onClick={() => setToast(null)} className="p-1 hover:bg-white/5 rounded" aria-label="Dismiss">
                                        <X className="w-4 h-4" />
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="bg-slate-900 border-b-2 border-racing-red">
                        <div className="p-4 sm:p-6 max-w-7xl mx-auto">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className="relative w-14 h-14 rounded-lg overflow-hidden shadow-xl">
                                        <div className="absolute inset-0 red-metallic"></div>
                                        <div className="absolute inset-0 metallic-shine opacity-30"></div>
                                        <div className="relative flex items-center justify-center h-full">
                                            <Dumbbell className="w-7 h-7 text-white drop-shadow-lg" />
                                        </div>
                                    </div>
                                    <div>
                                        <h1 className="text-3xl font-racing tracking-wider text-white">IRONFLOW</h1>
                                        <p className="text-xs text-slate-400 tracking-widest">PRECISION TRAINING</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <div className="flex items-center bg-slate-950 border border-slate-700 rounded-lg overflow-hidden">
                                        <button
                                            onClick={() => setActiveView('workout')}
                                            className={`px-3 py-2 flex items-center gap-2 transition-all ${activeView === 'workout' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-900'}`}
                                            aria-label="Workout view"
                                        >
                                            <Dumbbell className="w-4 h-4" />
                                            <span className="font-racing text-sm">WORKOUT</span>
                                        </button>
                                        <button
                                            onClick={() => setActiveView('history')}
                                            className={`px-3 py-2 flex items-center gap-2 transition-all ${activeView === 'history' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-900'}`}
                                            aria-label="History view"
                                        >
                                            <Calendar className="w-4 h-4" />
                                            <span className="font-racing text-sm">HISTORY</span>
                                        </button>
                                    </div>
                                    {getTotalSetsLogged() > 0 && (
                                        <button onClick={() => setShowWorkoutSummary(true)} className="px-4 py-2 bg-racing-red hover:bg-red-600 rounded-lg transition-all flex items-center gap-2">
                                            <Save className="w-4 h-4" />
                                            <span className="font-racing text-sm">SAVE ({getTotalSetsLogged()})</span>
                                        </button>
                                    )}
                                    <button onClick={() => setShowSettings(true)} className="p-3 hover:bg-slate-800 rounded-lg transition-all border border-slate-700">
                                        <Settings className="w-5 h-5 text-slate-400" />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 sm:p-6">
                        {activeView === 'workout' ? (
                            <>
                                <div className="flex gap-3 mb-6 overflow-x-auto scrollbar-hide pb-2">
                                    {Object.entries(programs).map(([key, program]) => (
                                        <button
                                            key={key}
                                            onClick={() => setActiveTab(key)}
                                            className={`flex-shrink-0 px-5 sm:px-6 py-3 font-racing text-lg tracking-wider transition-all ${
                                                activeTab === key ? 'bg-racing-red text-white scale-105' : 'bg-slate-800 text-slate-400'
                                            }`}
                                            style={{ clipPath: 'polygon(8% 0%, 100% 0%, 92% 100%, 0% 100%)' }}
                                        >
                                            {program.name}
                                        </button>
                                    ))}
                                </div>

                                {/* Workout type selector (saved name). Premium + mobile-friendly. */}
                                <div className="mb-5 bg-slate-900/70 border border-slate-800 rounded-xl p-4 sm:p-5 shadow-[0_10px_30px_rgba(0,0,0,0.35)]">
                                    <div className="flex flex-col sm:flex-row sm:items-end gap-3 sm:gap-4">
                                        <div className="flex-1">
                                            <p className="text-xs text-slate-500 font-racing tracking-widest mb-2">WORKOUT TYPE</p>
                                            <div className="relative">
                                                <select
                                                    value={workoutType}
                                                    onChange={(e) => {
                                                        const v = e.target.value;
                                                        if (v === '__custom__') {
                                                            setWorkoutType('__custom__');
                                                            if (!customWorkoutType) setCustomWorkoutType('');
                                                        } else {
                                                            setWorkoutType(v);
                                                        }
                                                    }}
                                                    className="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-3 pr-10 text-white font-racing text-base focus:border-racing-blue outline-none appearance-none"
                                                    aria-label="Workout type"
                                                >
                                                    {WORKOUT_TYPE_OPTIONS.map((opt) => (
                                                        <option key={opt} value={opt}>{opt}</option>
                                                    ))}
                                                    <option value="__custom__">Custom...</option>
                                                </select>
                                                <div className="pointer-events-none absolute inset-y-0 right-3 flex items-center">
                                                    <ChevronDown className="w-4 h-4 text-slate-400" />
                                                </div>
                                            </div>
                                        </div>

                                        {isCustomWorkoutType && (
                                            <div className="flex-1">
                                                <p className="text-xs text-slate-500 font-racing tracking-widest mb-2">CUSTOM NAME</p>
                                                <input
                                                    type="text"
                                                    value={customWorkoutType}
                                                    onChange={(e) => setCustomWorkoutType(e.target.value)}
                                                    className="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-3 text-white font-racing text-base focus:border-racing-blue outline-none"
                                                    placeholder="e.g., Upper Body"
                                                />
                                            </div>
                                        )}
                                    </div>
                                    <p className="mt-3 text-xs text-slate-500">Saved workouts will use: <span className="text-slate-200 font-medium">{getEffectiveWorkoutType()}</span></p>
                                </div>

                                <div className="space-y-4">
                                    {programs[activeTab].exercises.map((ex) => {
                                        const displayName = getDisplayExercise(ex.name);
                                        const isCustom = displayName !== ex.name;
                                        const exerciseData = currentWorkout[ex.id];
                                        const targetSets = getTargetSets(ex.id, ex.sets);

                                        return (
                                            <div key={ex.id} className="bg-slate-900 border-2 border-slate-800 hover:border-racing-red transition-all" style={{ clipPath: 'polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%)' }}>
                                                <button onClick={() => setExpandedExercise(expandedExercise === ex.id ? null : ex.id)} className="w-full p-4 sm:p-6 flex items-center justify-between text-left">
                                                    <div className="flex-1">
                                                        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-2">
                                                            
<div className="flex items-start gap-2 min-w-0 flex-1">
    <div className="min-w-0 flex-1">
        <div className="relative">
            <select
                value={displayName}
                onClick={(e) => { e.preventDefault(); e.stopPropagation(); }}
                onChange={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const v = e.target.value;

                    if (v === '__original__') {
                        resetExercise(ex.name);
                        setCustomEdit({ originalName: null, value: '' });
                        return;
                    }

                    if (v === '__custom__') {
                        setExpandedExercise(ex.id);
                        const existing = getDisplayExercise(ex.name);
                        setCustomEdit({ originalName: ex.name, value: existing === ex.name ? '' : existing });
                        return;
                    }

                    substituteExercise(ex.name, v);
                    setCustomEdit({ originalName: null, value: '' });
                }}
                className="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 pr-10 text-white font-bold text-lg focus:border-racing-blue outline-none appearance-none"
                aria-label="Select exercise"
            >
                <option value={displayName}>{displayName}</option>
                <option value="__original__">Reset to: {ex.name}</option>
                {(EXERCISE_SUBS[ex.name] || []).map((alt) => (
                    <option key={alt.name} value={alt.name}>{alt.name}</option>
                ))}
                <option value="__custom__">Custom exercise...</option>
            </select>
            <div className="pointer-events-none absolute inset-y-0 right-3 flex items-center">
                <ChevronDown className="w-4 h-4 text-slate-400" />
            </div>
        </div>
    </div>

    {isCustom && <span className="px-2 py-0.5 bg-racing-blue/20 border border-racing-blue text-racing-blue text-xs font-racing self-center">ALT</span>}
    {exerciseData && Object.keys(exerciseData.sets).length > 0 && (
        <span className="px-2 py-0.5 bg-racing-red/20 border border-racing-red text-racing-red text-xs font-racing self-center">
            {Object.keys(exerciseData.sets).length}/{targetSets} LOGGED
        </span>
    )}
</div>
</div>
                                                        <div className="flex flex-wrap gap-5 text-sm items-center">
                                                            <span className="flex items-center gap-2 text-slate-400">
                                                                <div className="w-2 h-2 rounded-full bg-racing-red gauge-indicator"></div>
                                                                <span className="font-racing">{targetSets} SETS</span>
                                                            </span>
                                                            <div className="flex items-center gap-2">
                                                                <button
                                                                    type="button"
                                                                    onClick={(e) => { e.preventDefault(); e.stopPropagation(); adjustTargetSets(ex.id, targetSets - 1); }}
                                                                    className="h-10 w-10 sm:h-8 sm:w-8 inline-flex items-center justify-center rounded border border-slate-700 bg-slate-950 hover:bg-slate-900"
                                                                    aria-label="Decrease sets"
                                                                >
                                                                    <Minus className="w-4 h-4 text-slate-300" />
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    onClick={(e) => { e.preventDefault(); e.stopPropagation(); adjustTargetSets(ex.id, targetSets + 1); }}
                                                                    className="h-10 w-10 sm:h-8 sm:w-8 inline-flex items-center justify-center rounded border border-slate-700 bg-slate-950 hover:bg-slate-900"
                                                                    aria-label="Increase sets"
                                                                >
                                                                    <Plus className="w-4 h-4 text-slate-300" />
                                                                </button>
                                                            </div>
                                                            <span className="flex items-center gap-2 text-slate-400">
                                                                <div className="w-2 h-2 rounded-full bg-racing-blue gauge-indicator" style={{animationDelay: '0.3s'}}></div>
                                                                <span className="font-racing">{ex.reps} REPS</span>
                                                            </span>
                                                            <span className="flex items-center gap-2 text-slate-400">
                                                                <div className="w-2 h-2 rounded-full bg-racing-cyan gauge-indicator" style={{animationDelay: '0.6s'}}></div>
                                                                <span className="font-racing">{ex.rest}S</span>
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <ChevronDown className={`w-6 h-6 text-slate-500 transition-transform ${expandedExercise === ex.id ? 'rotate-180 text-racing-red' : ''}`} />
                                                </button>

                                                {expandedExercise === ex.id && (
                                                    <div className="px-4 sm:px-6 pb-5 sm:pb-6 border-t-2 border-slate-800 pt-4 sm:pt-5 space-y-4">
                                                        <div className="space-y-2">
                                                            {customEdit.originalName === ex.name && (
                                                                <div className="bg-slate-950 p-4 rounded border border-slate-800">
                                                                    <p className="text-xs text-slate-500 font-racing mb-2">CUSTOM EXERCISE NAME</p>
                                                                    <div className="flex flex-col sm:flex-row gap-3">
                                                                        <input
                                                                            type="text"
                                                                            value={customEdit.value}
                                                                            onClick={(e) => e.stopPropagation()}
                                                                            onChange={(e) => setCustomEdit({ originalName: ex.name, value: e.target.value })}
                                                                            className="flex-1 bg-slate-900 border border-slate-700 px-3 py-2 text-white font-racing text-base rounded focus:border-racing-blue outline-none"
                                                                            placeholder="Type an exercise name..."
                                                                        />
                                                                        <div className="flex gap-2">
                                                                            <button
                                                                                type="button"
                                                                                onClick={(e) => {
                                                                                    e.preventDefault();
                                                                                    e.stopPropagation();
                                                                                    const val = (customEdit.value || '').trim();
                                                                                    if (!val) {
                                                                                        setToast({ type: 'error', message: 'Enter an exercise name or choose one from the list.' });
                                                                                        return;
                                                                                    }
                                                                                    substituteExercise(ex.name, val);
                                                                                    setCustomEdit({ originalName: null, value: '' });
                                                                                    setToast({ type: 'success', message: 'Exercise updated.' });
                                                                                }}
                                                                                className="h-10 px-4 bg-racing-blue hover:opacity-90 rounded-lg font-racing text-sm tracking-wider"
                                                                            >
                                                                                SAVE
                                                                            </button>
                                                                            <button
                                                                                type="button"
                                                                                onClick={(e) => {
                                                                                    e.preventDefault();
                                                                                    e.stopPropagation();
                                                                                    setCustomEdit({ originalName: null, value: '' });
                                                                                }}
                                                                                className="h-10 px-4 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg font-racing text-sm tracking-wider"
                                                                            >
                                                                                CANCEL
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}

                                                            {[...Array(targetSets)].map((_, setIdx) => {
                                                                const setNum = setIdx + 1;
                                                                const setData = exerciseData?.sets?.[setNum];
                                                                return (
                                                                    <div key={setNum} className="bg-slate-950 p-4 rounded border border-slate-800">
                                                                        <div className="flex items-center gap-4">
                                                                            <div className="w-12 flex-shrink-0">
                                                                                <p className="text-xs text-slate-500 font-racing">SET</p>
                                                                                <p className="text-2xl font-racing text-racing-red">{setNum}</p>
                                                                            </div>
                                                                            <div className="flex-1 grid grid-cols-2 gap-3">
                                                                                <div>
                                                                                    <label className="text-xs text-slate-500 font-racing">WEIGHT (LBS)</label>
                                                                                    <input
                                                                                        type="number"
                                                                                        step="0.5"
                                                                                        value={setData?.weight || ''}
                                                                                        onChange={(e) => logSet(ex.id, setNum, e.target.value, setData?.reps || '')}
                                                                                        className="w-full bg-slate-900 border border-slate-700 px-3 py-2 text-white font-racing text-lg rounded focus:border-racing-blue outline-none"
                                                                                        placeholder="135"
                                                                                    />
                                                                                </div>
                                                                                <div>
                                                                                    <label className="text-xs text-slate-500 font-racing">REPS</label>
                                                                                    <input
                                                                                        type="number"
                                                                                        value={setData?.reps || ''}
                                                                                        onChange={(e) => logSet(ex.id, setNum, setData?.weight || '', e.target.value)}
                                                                                        className="w-full bg-slate-900 border border-slate-700 px-3 py-2 text-white font-racing text-lg rounded focus:border-racing-blue outline-none"
                                                                                        placeholder="10"
                                                                                    />
                                                                                </div>
                                                                            </div>
                                                                            {setData && (
                                                                                <Check className="w-6 h-6 text-racing-cyan flex-shrink-0" />
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>

                                                        <div className="pt-4 border-t border-slate-800">
                                                            {isCustom && (
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        resetExercise(ex.name);
                                                                    }}
                                                                    className="w-full mt-2 py-2 text-xs font-racing text-slate-500 hover:text-racing-red transition-colors flex items-center justify-center gap-2"
                                                                >
                                                                    <RefreshCw className="w-3 h-3" />
                                                                    RESET TO: {ex.name}
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </>
                        ) : (
                            <div className="space-y-4">
                                <div className="bg-slate-900 border border-slate-800 p-5">
                                    <div className="flex items-center justify-between gap-4">
                                        <div>
                                            <h2 className="text-2xl font-racing text-white">WORKOUT HISTORY</h2>
                                            <p className="text-sm text-slate-400 mt-1">History is loaded from your connected Google Sheet.</p>
                                        </div>
                                        <button
                                            onClick={loadHistoryFromSheets}
                                            className="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg flex items-center gap-2"
                                        >
                                            <RefreshCw className="w-4 h-4" />
                                            <span className="font-racing text-sm">REFRESH</span>
                                        </button>
                                    </div>

                                    {(!sheetUrl || !scriptUrl) && (
                                        <div className="mt-4 p-4 bg-slate-950 border border-slate-800">
                                            <p className="text-sm text-slate-300">Connect your Google Sheet in Settings to view history.</p>
                                        </div>
                                    )}
                                    {historyStatus.loading && (
                                        <div className="mt-4 p-4 bg-slate-950 border border-slate-800">
                                            <p className="text-sm text-slate-300">Loading...</p>
                                        </div>
                                    )}
                                    {historyStatus.error && (
                                        <div className="mt-4 p-4 bg-red-950/30 border border-red-700">
                                            <p className="text-sm text-red-200">{historyStatus.error}</p>
                                        </div>
                                    )}
                                </div>

                                {historyItems.length === 0 && !historyStatus.loading && !historyStatus.error && sheetUrl && scriptUrl && (
                                    <div className="bg-slate-900 border border-slate-800 p-5">
                                        <p className="text-sm text-slate-400">No workouts found yet.</p>
                                    </div>
                                )}

                                <div className="space-y-3">
                                    {historyItems.map((w, idx) => (
                                        <div key={idx} className="bg-slate-900 border-2 border-slate-800" style={{ clipPath: 'polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%)' }}>
                                            <div className="p-5 border-b border-slate-800">
                                                <div className="flex items-center justify-between gap-4">
                                                    <div>
                                                        <p className="font-racing text-sm text-slate-400">{w.programName || w.program || 'Workout'}</p>
                                                        <p className="text-white font-semibold mt-1">{new Date(w.date || w.timestamp || Date.now()).toLocaleDateString()}</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="text-xs font-racing text-slate-500">SETS</p>
                                                        <p className="text-xl font-racing text-racing-red">{w.totalSets || 0}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="p-5 space-y-2">
                                                {(w.exercises || []).slice(0, 8).map((ex, j) => (
                                                    <div key={j} className="flex items-center justify-between gap-4">
                                                        <p className="text-sm text-white">{ex.name}</p>
                                                        <p className="text-xs text-slate-400 font-racing">{ex.setsLogged} sets</p>
                                                    </div>
                                                ))}
                                                {(w.exercises || []).length > 8 && (
                                                    <p className="text-xs text-slate-500 font-racing">+{(w.exercises || []).length - 8} more</p>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Exercise Substitution Modal */}
                    {showSubstitutes && selectedExercise && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn">
                            <div className="bg-slate-900 w-full max-w-md max-h-[80vh] border-2 border-racing-blue shadow-2xl overflow-hidden flex flex-col">
                                <div className="p-6 border-b-2 border-slate-800">
                                    <div className="flex items-center justify-between mb-3">
                                        <h2 className="text-2xl font-racing text-white">SWITCH EXERCISE</h2>
                                        <button onClick={() => setShowSubstitutes(false)} className="p-2 hover:bg-slate-800 rounded-lg">
                                            <X className="w-6 h-6 text-slate-400" />
                                        </button>
                                    </div>
                                    <p className="text-sm text-slate-400">Alternatives for: <span className="font-semibold text-white">{selectedExercise.name}</span></p>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {EXERCISE_SUBS[selectedExercise.name]?.map((alt, idx) => (
                                        <button 
                                            key={idx} 
                                            onClick={() => substituteExercise(selectedExercise.name, alt.name)} 
                                            className="w-full text-left bg-slate-800 hover:bg-slate-750 border border-slate-700 hover:border-racing-blue p-4 transition-all group"
                                        >
                                            <div className="flex items-start justify-between gap-3">
                                                <div className="flex-1">
                                                    <p className="font-semibold text-white mb-1 group-hover:text-racing-blue">{alt.name}</p>
                                                    <div className="flex gap-3 text-xs">
                                                        <span className="px-2 py-0.5 bg-slate-900 text-slate-400 font-racing">{alt.difficulty}</span>
                                                        <span className="px-2 py-0.5 bg-slate-900 text-slate-400 font-racing">{alt.equipment}</span>
                                                    </div>
                                                </div>
                                                <ChevronRight className="w-5 h-5 text-slate-600 group-hover:text-racing-blue flex-shrink-0" />
                                            </div>
                                        </button>
                                    )) || <div className="text-center py-8 text-slate-500"><p className="font-racing">No alternatives available</p></div>}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Workout Summary Modal */}
                    {showWorkoutSummary && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn">
                            <div className="bg-slate-900 w-full max-w-md border-2 border-racing-red shadow-2xl">
                                <div className="p-6 border-b-2 border-slate-800">
                                    <div className="flex items-center justify-between mb-3">
                                        <h2 className="text-3xl font-racing text-white">SAVE WORKOUT</h2>
                                        <button onClick={() => setShowWorkoutSummary(false)} className="p-2 hover:bg-slate-800 rounded-lg">
                                            <X className="w-7 h-7 text-slate-400" />
                                        </button>
                                    </div>
                                    <p className="text-sm text-slate-400">{new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                </div>

                                <div className="p-6 space-y-4">
                                    <div className="space-y-3">
                                        {Object.keys(currentWorkout).map(exerciseId => {
                                            const exercise = programs[activeTab].exercises.find(e => e.id === exerciseId);
                                            const sets = currentWorkout[exerciseId].sets;
                                            return (
                                                <div key={exerciseId} className="bg-slate-950 p-4 rounded border-l-4 border-racing-red">
                                                    <p className="font-semibold text-white mb-2">{getDisplayExercise(exercise.name)}</p>
                                                    <div className="space-y-1">
                                                        {Object.entries(sets).map(([setNum, data]) => (
                                                            <p key={setNum} className="text-sm text-slate-400 font-racing">
                                                                Set {setNum}: {data.weight}lbs  {data.reps} reps
                                                            </p>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div className="grid grid-cols-2 gap-3 pt-4">
                                        <button onClick={clearWorkout} className="py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 font-racing text-white rounded transition-all">
                                            DISCARD
                                        </button>
                                        <button onClick={saveWorkout} className="relative overflow-hidden">
                                            <div className="absolute inset-0 red-metallic"></div>
                                            <div className="absolute inset-0 metallic-shine opacity-30"></div>
                                            <div className="relative py-3 font-racing text-white flex items-center justify-center gap-2">
                                                <Check className="w-5 h-5" />
                                                SAVE
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn">
                            <div className="bg-slate-900 w-full max-w-md border-2 border-slate-700 shadow-2xl">
                                <div className="p-6 border-b-2 border-slate-800">
                                    <div className="flex items-center justify-between">
                                        <h2 className="text-3xl font-racing text-white">SETTINGS</h2>
                                        <button onClick={() => setShowSettings(false)} className="p-2 hover:bg-slate-800 rounded-lg">
                                            <X className="w-7 h-7 text-slate-400" />
                                        </button>
                                    </div>
                                </div>

                                <div className="p-6 space-y-6">
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-racing mb-3 text-slate-400">GOOGLE SHEET URL</label>
                                            <input
                                                type="text"
                                                value={sheetUrl}
                                                onChange={(e) => setSheetUrl(e.target.value)}
                                                className="w-full bg-slate-950 border-2 border-slate-700 px-4 py-3 text-white focus:border-racing-blue outline-none text-sm"
                                                placeholder="https://docs.google.com/spreadsheets/d/..."
                                            />
                                            <p className="text-xs text-slate-500 mt-2">This should be the sheet that already contains your training history.</p>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-racing mb-3 text-slate-400">APPS SCRIPT WEB APP URL</label>
                                            <input
                                                type="text"
                                                value={scriptUrl}
                                                onChange={(e) => setScriptUrl(e.target.value)}
                                                className="w-full bg-slate-950 border-2 border-slate-700 px-4 py-3 text-white focus:border-racing-blue outline-none text-sm"
                                                placeholder="https://script.google.com/macros/s/.../exec"
                                            />
                                            <p className="text-xs text-slate-500 mt-2">This comes from Apps Script  Deploy  Web app.</p>
                                        </div>
                                    </div>

                                    <div className="bg-slate-950 border border-slate-800 p-4 space-y-3">
                                        <h3 className="font-racing text-sm text-white">HOW SAVING WORKS</h3>
                                        <ol className="list-decimal ml-5 space-y-2 text-xs text-slate-300">
                                            <li>Open your Google Sheet  Extensions  Apps Script.</li>
                                            <li>Paste the code from <span className="font-racing">google-sheets-integration.gs</span> (included in this repo).</li>
                                            <li>Deploy as a Web app. Set access to <span className="font-racing">Anyone</span> and execute as <span className="font-racing">Me</span>.</li>
                                            <li>Copy the Web app URL and paste it above.</li>
                                            <li>Paste your Google Sheet URL above, then press <span className="font-racing">SAVE SETTINGS</span>.</li>
                                        </ol>
                                        <div className="flex gap-2 pt-1">
                                            <button
                                                onClick={async () => {
                                                    localStorage.setItem('sheetUrl', sheetUrl);
                                                    localStorage.setItem('scriptUrl', scriptUrl);
                                                    showToast('success', 'Settings saved.');
                                                    // Optional: test history load
                                                    await loadHistoryFromSheets();
                                                    setShowSettings(false);
                                                }}
                                                className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 font-racing text-white rounded transition-all"
                                            >
                                                SAVE SETTINGS
                                            </button>
                                            <button
                                                onClick={async () => {
                                                    if (!sheetUrl || !scriptUrl) {
                                                        showToast('error', 'Paste both the Sheet URL and the Web App URL first.');
                                                        return;
                                                    }
                                                    const spreadsheetId = extractSpreadsheetId(sheetUrl);
                                                    if (!spreadsheetId) {
                                                        showToast('error', 'Invalid Google Sheet URL.');
                                                        return;
                                                    }
                                                    try {
                                                        const postBody = JSON.stringify({
                                                            action: 'append_workout',
                                                            spreadsheetId,
                                                            payload: {
                                                                timestamp: new Date().toISOString(),
                                                                program: activeTab,
                                                                workoutName: 'Test Save',
                                                                exercises: []
                                                            }
                                                        });
                                                        await postToAppsScript(scriptUrl, postBody);
                                                        showToast('success', 'Test save sent. Check your sheet for a new row.');
                                                    } catch (e) {
                                                        console.error(e);
                                                        showToast('error', 'Test save failed. Check deployment permissions.');
                                                    }
                                                }}
                                                className="px-4 py-3 bg-slate-900 hover:bg-slate-800 border border-slate-700 font-racing text-white rounded transition-all"
                                            >
                                                TEST SAVE
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
